---
title: "ProjectX"
author: "Taobenson"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
# Global options for the RMarkdown document
knitr::opts_chunk$set(include = TRUE,
                      message = FALSE, warning = FALSE, 
                      fig.align = "center",  out.width = "80%")
```

```{r}
library(tidyverse)
library(maps)
library(ggplot2)
library(maps)
library(ggrepel)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)  # Needed for spatial data handling

# Load datasets
expeditions <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-01-21/exped_tidy.csv')
peaks <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-01-21/peaks_tidy.csv')

# Merge datasets on PEAKID
merged_df <- expeditions %>%
  left_join(peaks, by = "PEAKID")
```
```{r}
# Function to classify regions
classify_region <- function(location) {
  if (str_detect(location, "Khumbu|Everest")) {
    return("Everest Region")
  } else if (str_detect(location, "Annapurna")) {
    return("Annapurna Region")
  } else if (str_detect(location, "Dhaulagiri")) {
    return("Dhaulagiri Region")
  } else if (str_detect(location, "Kangchenjunga")) {
    return("Kangchenjunga Region")
  } else if (str_detect(location, "Manaslu")) {
    return("Manaslu Region")
  } else if (str_detect(location, "Makalu")) {
    return("Makalu Region")
  } else if (str_detect(location, "Langtang")) {
    return("Langtang Region")
  } else if (str_detect(location, "Rolwaling|Jugal")) {
    return("Rolwaling & Jugal Region")
  } else if (str_detect(location, "Saipal|Api")) {
    return("Far Western Himalayas")
  } else {
    return("Other")
  }
}

# Apply classification
merged_df <- merged_df %>%
  mutate(General_Region = sapply(LOCATION, classify_region))


```

```{r}
# Manually set lat/lon for each general region
region_coords <- tibble(
  General_Region = c("Everest Region", "Annapurna Region", "Dhaulagiri Region", 
                     "Kangchenjunga Region", "Manaslu Region", "Makalu Region", 
                     "Langtang Region", "Rolwaling & Jugal Region", "Far Western Himalayas"),
  Latitude = c(27.9881, 28.5961, 28.6961, 27.7025, 28.5494, 27.8897, 
               28.2000, 27.6000, 29.5000),
  Longitude = c(86.9250, 83.8203, 83.4875, 88.1466, 84.5598, 87.0883, 
                85.5000, 86.2000, 81.3000)
)


plot_prep <- merged_df %>%
  group_by(General_Region) %>%
  summarise(
    total_expeditions = n(),
    avg_success_rate = mean(c(SUCCESS1, SUCCESS2, SUCCESS3, SUCCESS4), na.rm = TRUE),
    avg_heightM = mean(HEIGHTM)) %>%
  left_join(region_coords, by = "General_Region")

```


```{r}
world_map <- map_data("world")

# Get country data for Asia
countries <- ne_countries(scale = "medium", returnclass = "sf")

# Filter for Nepal, China, and India (Himalayan region)
himalayan_countries <- countries %>% 
  filter(admin %in% c("Nepal", "China", "India"))

# Extract centroids for country labels
country_labels <- st_centroid(himalayan_countries)

# Manually adjust Nepal's label position (between 6540m and 7848m)
nepal_label <- tibble(
  admin = "Nepal",
  Longitude = 82.5,  # Adjusted to be between 6540m and 7848m
  Latitude = 28.5
)

# Adjust peak height differentiation for 7926m and 8327m
height_lines <- plot_prep %>% filter(avg_heightM %in% c(7926, 8327))

# Move `8327m` higher
height_lines <- height_lines %>%
  mutate(nudge = ifelse(avg_heightM == 8327, 0.25, 0.15))  # Increase separation

# Plot the data
ggplot() +
  geom_polygon(data = world_map, aes(x = long, y = lat, group = group), 
               fill = "lightgray", color = "white") +
  
  # Expedition count as CIRCLES
  geom_point(data = plot_prep, aes(x = Longitude, y = Latitude, 
                                   size = total_expeditions, 
                                   color = avg_success_rate),
             alpha = 0.7) +
  
  # Scale for expedition size
  scale_size_continuous(range = c(3, 10), name = "Expeditions") +
  
  # Scale for success rate
  scale_color_gradient2(low = "red", mid = "yellow", high = "green", 
                        midpoint = 0.175, limits = c(0.1, 0.25), 
                        name = "Success Rate") +
  
  # Move Peak Height Labels BELOW Mountains, Add "m" to Values
  geom_text_repel(data = plot_prep, aes(x = Longitude, y = Latitude, 
                                        label = paste0(round(avg_heightM, 0), "m")), 
                  size = 3, fontface = "bold", color = "black", 
                  nudge_y = -0.15, vjust = 1.5,  # Moves text slightly downward but not too much
                  segment.color = NA) +         # Removes connecting lines

  # Add clearer lines to separate 7926m and 8327m
  geom_segment(data = height_lines,
               aes(x = Longitude, xend = Longitude, 
                   y = Latitude, yend = Latitude - nudge), 
               color = "black", size = 0.5) +  

  # Move Nepal to a better space between 6540m and 7848m
  geom_text(data = nepal_label, aes(x = Longitude, y = Latitude, label = admin),
            fontface = "bold", size = 5, color = "black") +

  # Country Labels (Keep China and India in place)
  geom_text_repel(data = country_labels %>% filter(admin != "Nepal"), 
                  aes(x = st_coordinates(geometry)[,1], 
                      y = st_coordinates(geometry)[,2], 
                      label = admin),
                  fontface = "bold", size = 5, color = "black",
                  nudge_y = 1, nudge_x = 0.5, 
                  segment.color = NA) +  # Removes country label connecting lines

  theme_minimal() +
  labs(title = "Himalayan Peak Expeditions by Region",
       subtitle = "Values below are Peak Heights in Metres (m)",  # Add clear subtitle
       x = "Longitude", y = "Latitude") +
  theme(legend.position = "bottom",legend.key.height = unit(0.5, "cm")) + 
  coord_cartesian(xlim = c(81, 88), ylim = c(26, 31))

```
